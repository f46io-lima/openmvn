image: docker:24.0.2

services:
  - name: docker:24.0.2-dind
    command: ["--tls=false"]
    alias: docker

variables:
  # Docker settings
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  DOCKER_DRIVER: overlay2
  DOCKER_BUILDKIT: 1
  DOCKER_CLI_EXPERIMENTAL: enabled
  # Service endpoints
  REDIS_ADDR: redis:6379
  NATS_URL: nats://nats:4222
  # Dynamic port allocation
  SMF_PORT: ${SMF_PORT:-8805}
  AMF_PORT: 8081
  OCS_PORT: 8082
  UDM_PORT: 8083
  BSS_PORT: 8084
  # Testcontainers
  TESTCONTAINERS_RYUK_DISABLED: "true"
  TESTCONTAINERS_DOCKER_SOCKET_OVERRIDE: "/var/run/docker.sock"
  # Build settings
  GO_VERSION: "1.21"
  GO_TEST_FLAGS: "-v -race -coverprofile=coverage.txt -covermode=atomic"
  GO_TEST_TIMEOUT: "10m"

stages:
  - build
  - test
  - integration-test
  - push
  - deploy

workflow:
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request"

before_script:
  - apk add --no-cache go git curl bash
  - |
    if [ -z "$SMF_PORT" ]; then
      export SMF_PORT=$(( (RANDOM % 55000) + 10000 ))
      echo "Using dynamic SMF port: $SMF_PORT"
    fi
  - |
    if [ "$CI_JOB_STAGE" = "build" ] || [ "$CI_JOB_STAGE" = "push" ] || [ "$CI_JOB_NAME" = "integration_tests" ]; then
      if [ -n "$CI_REGISTRY_PASSWORD" ] && [ -n "$CI_REGISTRY_USER" ] && [ -n "$CI_REGISTRY" ]; then
        echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
      else
        echo "Skipping Docker login – no credentials available"
        exit 1
      fi
    fi
  - docker ps -aq | xargs -r docker rm -f || true
  - docker network prune -f || true

build_services:
  stage: build
  script:
    - docker-compose build
  artifacts:
    paths:
      - ./*/Dockerfile
      - docker-compose.yml
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request"

unit_tests:
  stage: test
  image: golang:$GO_VERSION-alpine
  services:
    - name: redis:7-alpine
      alias: redis
    - name: nats:2.10.11-alpine
      alias: nats
      command: ["-js"]
  script:
    - echo "CODECOV_TOKEN: $CODECOV_TOKEN"
    - |
      for svc in amf smf ocs upf bss imsi-manager imsi-switch-receiver; do
        echo "🧪 Testing $svc..."
        cd $svc
        go mod tidy
        go test $GO_TEST_FLAGS -timeout $GO_TEST_TIMEOUT ./...
        if [ -f coverage.txt ]; then
          curl -s https://codecov.io/bash | bash -s -- -f coverage.txt -t $CODECOV_TOKEN
        fi
        cd ..
      done
  coverage: '/coverage: \d+\.\d+% of statements/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: "**/coverage.txt"
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

integration_tests:
  stage: integration-test
  image: golang:$GO_VERSION-alpine
  services:
    - name: docker:dind
      alias: docker
      command: ["--tls=false"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - apk add --no-cache docker-cli
    - go install github.com/codecov/codecov-go@latest
  script:
    - |
      cd integration_test
      go mod tidy
      go test $GO_TEST_FLAGS -timeout $GO_TEST_TIMEOUT ./...
      if [ -f coverage.integration.txt ]; then
        curl -s https://codecov.io/bash | bash -s -- -f coverage.integration.txt -t $CODECOV_TOKEN
      fi
  coverage: '/coverage: \d+\.\d+% of statements/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: "**/coverage.integration.txt"
    when: on_failure
    paths:
      - integration_test/*.log
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request"
      when: manual
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: on_success

kaniko_push:
  image: gcr.io/kaniko-project/executor:latest
  stage: push
  variables:
    VERSION: "${CI_COMMIT_TAG:-$CI_COMMIT_SHA}"
    DOCKER_BUILDKIT: 1
    DOCKER_CLI_EXPERIMENTAL: enabled
  before_script:
    - echo "🔐 Authenticating Kaniko to Docker registry..."
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
  script:
    - |
      echo "📦 Building version: $VERSION"
      for svc in amf smf ocs upf bss imsi-manager imsi-switch-receiver; do
        echo "📦 Pushing $svc with Kaniko..."
        /kaniko/executor \
          --context "$CI_PROJECT_DIR/$svc" \
          --dockerfile "$CI_PROJECT_DIR/$svc/Dockerfile" \
          --destination "$CI_REGISTRY_IMAGE/$svc:$VERSION" \
          --destination "$CI_REGISTRY_IMAGE/$svc:latest" \
          --cache=true \
          --cache-ttl=24h \
          --push-retry=3 \
          --log-format=text \
          --log-timestamp \
          --skip-tls-verify=false \
          --insecure=false
      done
  after_script:
    - 'echo "✅ Push completed for version: $VERSION"'
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
      when: on_success
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
  artifacts:
    reports:
      dotenv: build.env
    expire_in: 1 week
    when: on_success

# Legacy push job - to be removed after migration
push_images:
  stage: push
  script:
    - |
      for svc in amf smf ocs upf bss imsi-manager imsi-switch-receiver; do
        echo "Pushing $svc..."
        docker tag openmvcore_$svc "$CI_REGISTRY_IMAGE/$svc:latest"
        docker tag openmvcore_$svc "$CI_REGISTRY_IMAGE/$svc:$CI_COMMIT_SHA"
        docker push "$CI_REGISTRY_IMAGE/$svc:latest"
        docker push "$CI_REGISTRY_IMAGE/$svc:$CI_COMMIT_SHA"
      done
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: manual
  allow_failure: true
